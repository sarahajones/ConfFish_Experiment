<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ConfFish-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>


    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>
    <script src="scripts/jspsych-demographics.js"></script>


    <!--custom JS: helpers-->
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>


    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">


</head>
<body class="main">
<div id="save-error">
    <h1>Error</h1>
    <p>There was an error testing whether data from the experiment could be saved to the server.
        If you would still like to participate, please contact the study lead on Prolific and we will try to figure out the issue for you. </p>
</div>
<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = 'R68879/RE001';
    var PIS_version = '1.0';
    var PIS_date = 'September 2020';
    var consent_version = '1.0';
    var consent_date = 'September 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg'
    ];

    /* EXPERIMENT VARIABLES */
    const trial_number = 20 ; //20 training trials

    const distribution1_1 = [
        {name: 'narrow', value: gaussian(222, 6400), color: 'blue1'}, //SD 80, var 6400
        {name: 'wide', value: gaussian(522, 19600), color: 'orange1'} //SD 140, var 19600
    ];

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    //splash loading screen
    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        trial_duration: 3750,
    };

    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };
    // CONSENT
    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };


    //DEMOGRAPHICS
    var demographics = {
        type: 'jspsych-demographics'
    };

    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        isFirstTime: true
    };



    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
       // splash_1, //happy
        //PIS, //saving?
        //consent, //saving?
        //splash_1, //happy
       // demographics, //saving?
        //tutorial_1, //change
        splash_1, //happy
    ];
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*/!*1st block training - TRIAL NUMBER 20*!/
    const train1_timeline = [];

    let trial_contents = quickfire_stimuli.map(
        s => {
            const outcome_chance = 1;
            const good = 'images/coins.png';
            const bad = 'images/bomb.png';
            let r;

            if (/orange/i.test(s)) {
                r = Math.random() < outcome_chance ? good : bad;
            } else if (/blue/i.test(s)) {
                r = Math.random() > outcome_chance ? good : bad;
            } else {
                console.warn(`Unrecognised spaceship colour in ${s}.`);
                return;
            }
            return {
                stimulus: s,
                result: r
            }
        });

    for (let i = 1; i <= trial_number; i++) {
        const trial_details = trial_contents.pop();
        train1_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus, 'images/package_image.png'],
            feedback: trial_details.result,
            trial_number: i,
            choices: ['Retrieve', 'Zap'],
            stimulus1_duration: 1500,
            gap_duration: 0,
            stimulus2_duration: 1500,
            trial_duration: 10000,
            feedback_duration: 2000,
            response_ends_trial: false,
            Zap1: 'images/zap1.png',
            Zap2: 'images/zap2.png',
        });
    }*/
 //////////////////////////////////////////////////////////////////////////////



    var fastdrop = {
            type: "jspsych-experimentscreen",
            trial_duration: 1500,
            stimulus_duration: 1000,
            confidence_trial: false,

        }

    const fastdrop_timeline = [
        fastdrop
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* Set up timeline and launch experiment*/

    const timeline = [
        ...intro_timeline,
        fastdrop_timeline,
    ];

    test_save()
        .then(()=>{
            /* start the experiment */
            jsPsych.init({
                timeline: timeline,
                on_trial_finish: save_csv,
                on_finish: save_csv
            });
        });

    /**
     * Save the jsPsych CSV output to the server
     */
    function save_csv() {
        if(!window.experiment_metadata) {
            // Get a user ID
            let id = jsPsych.data.getURLVariable('PROLIFIC_PID');
            if(typeof id !== "string")
                id = "ID" + (10 + Math.floor(Math.random() * 89)) +
                    "T" + Math.floor(performance.timeOrigin);

            jsPsych.data.addProperties({user_id: id});

            // Fetch all the experiment data and send it to the server
            window.experiment_metadata = {
                user_id: id,
                experiment: 'zapBox',
                version: [0, 1, 0]
            };
        }

        const data = {
            ...window.experiment_metadata,
            csv: jsPsych.data.get().csv()
        };

        fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify(data),
                type: 'application/json'
            }
        )
            .then(r => r.text())
            .then(b => console.log(b));
    }

    /**
     * Test the ability to save files on the server
     */
    function test_save() {
        return fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify({user_id: "test_id"}),
                type: 'application/json'
            }
        )
            .then(r => {
                if (r.status !== 200) {
                    document.getElementById('save-error').classList.add('show');
                    throw new Error('Problem saving data');
                }
                else
                    console.log('Save data test okay!');
            });
    }

</script>
</body>
</html>