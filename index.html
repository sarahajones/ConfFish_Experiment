<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ConfFish-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>


    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-demographics.js"></script>

    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>

    <script src="scripts/jspsych-quickfire.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>



    <!--custom JS: helpers-->
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>


    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">


</head>
<body class="main">
<div id="save-error">
    <h1>Error</h1>
    <p>There was an error testing whether data from the experiment could be saved to the server.
        If you would still like to participate, please contact the study lead on Prolific and we will try to figure out the issue for you. </p>
</div>
<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = 'R68879/RE001';
    var PIS_version = '1.0';
    var PIS_date = 'September 2020';
    var consent_version = '1.0';
    var consent_date = 'September 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg' +
        'images/training_fish_native.png' +
        'images/training_fish_invasive.png'
    ];

    /* EXPERIMENT VARIABLES */
    const train_trial_number = 4 ; //4 training trials

    train1_stimuli = [
        'images/training_fish_native.png',
        'images/training_fish_invasive.png'
    ];

    const deck_count = train_trial_number / train1_stimuli.length;
    train1_stimuli = shuffle_shoe(train1_stimuli, deck_count); //shuffle deck

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    //splash loading screen
    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        trial_duration: 3750,
    };

    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };
    // CONSENT
    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };


    //DEMOGRAPHICS
    var demographics = {
        type: 'jspsych-demographics'
    };

    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        tutorial_count: 1
    };
    var tutorial_2 = {
        type: "jspsych-tutorial",
        tutorial_count: 2
    };
    var tutorial_3 = {
        type: "jspsych-tutorial",
        tutorial_count: 3
    };

    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
        splash_1, //happy
        PIS, //saving?
        consent, //saving?
        splash_1, //happy
        demographics, //saving?
        splash_1, //happy
        tutorial_1, //change
        tutorial_2,
        tutorial_3,
        splash_1, //happy
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //!*1st block training - TRIAL NUMBER 20*!//
    const train1_timeline = [];

    let trial_contents = train1_stimuli.map(
        s => {
            return {
                stimulus: s,
            }
        });

    for (let i = 1; i <= train_trial_number; i++) {
        const trial_details = trial_contents.pop();
        train1_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus],
            trial_number: i,
            choices: ['Catch', 'Return'],
            stimulus_duration: 1500,
            trial_duration: 50000,
            response_ends_trial: true,
        });
    }

    //make it so that if they fail the training they get cycled back to the tutorials
    // and they let them get one more shot before getting kicked out.

 ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var block1 = {
            type: "jspsych-experimentscreen",
            trial_duration: 15000000,
            stimulus_duration: 1000000,
            confidence_trial: false,
            choices: ['Retrieve', 'Zap'],

        }

    const block1_timeline = [
        block1
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* Set up timeline and launch experiment*/

    const timeline = [
        //...intro_timeline,
        //...train1_timeline,
        ...block1_timeline,
    ];

    test_save()
        .then(()=>{
            /* start the experiment */
            jsPsych.init({
                timeline: timeline,
                on_trial_finish: save_csv,
                on_finish: save_csv
            });
        });

    /**
     * Save the jsPsych CSV output to the server
     */
    function save_csv() {
        if(!window.experiment_metadata) {
            // Get a user ID
            let id = jsPsych.data.getURLVariable('PROLIFIC_PID');
            if(typeof id !== "string")
                id = "ID" + (10 + Math.floor(Math.random() * 89)) +
                    "T" + Math.floor(performance.timeOrigin);

            jsPsych.data.addProperties({user_id: id});

            // Fetch all the experiment data and send it to the server
            window.experiment_metadata = {
                user_id: id,
                experiment: 'zapBox',
                version: [0, 1, 0]
            };
        }

        const data = {
            ...window.experiment_metadata,
            csv: jsPsych.data.get().csv()
        };

        fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify(data),
                type: 'application/json'
            }
        )
            .then(r => r.text())
            .then(b => console.log(b));
    }

    /**
     * Test the ability to save files on the server
     */
    function test_save() {
        return fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify({user_id: "test_id"}),
                type: 'application/json'
            }
        )
            .then(r => {
                if (r.status !== 200) {
                    document.getElementById('save-error').classList.add('show');
                    throw new Error('Problem saving data');
                }
                else
                    console.log('Save data test okay!');
            });
    }

</script>
</body>
</html>